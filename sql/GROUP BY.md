# GROUP BY

## WHAT?

> SQL clause used to devide data into groups for better analysis and data readiblity.

## SYNTAX

```sql
SELECT c1, c2
FROM R
GROUP BY c1, c2;
```

```sql
SELECT c1, AGG(c2)
FROM R
GROUP BY c1;
```

## Examples

```sql
SELECT lo_prompt_category, COUNT(*) AS num_prompts
FROM llm_output_v2
GROUP BY lo_prompt_category;
```

> We will see other examples on lab.

## Aggregate Functions

> To see the full potential of Aggregate functions with GROUP BY.
> You can get the statistical values for each group.

### Examples on Aggregate with groups

```sql
SELECT
    lo_model_name,
    COUNT(DISTINCT lo_user_email) AS unique_users_per_model
FROM
    llm_output_v2
GROUP BY
    lo_model_name;
```

> Rest of examples we will work on lab.

## Implicit Versus Explicit Groups

> By default, when you use AGG functions, SQL will deal with the query as a single group of records with implict group by clause.
> Here is the single group: outputs generated by llama-4:

```sql
SELECT
    COUNT(DISTINCT lo_user_email) AS 'unique_users_by_llama-4'
FROM
    llm_output_v2
WHERE lo_model_name LIKE 'llama-4';
```

> It is more convienent to retrieve additional columns to make the resultset more readable.

The following query will do the job (partially), why?

```sql
SELECT
    lo_model_name,
    COUNT(DISTINCT lo_user_email) AS 'unique_users_per_model'
FROM
    llm_output_v2;
```

> The correct query:

```sql
SELECT
    lo_model_name,
    COUNT(lo_user_email) AS 'unique_users_per_model'
FROM
    llm_output_v2
GROUP BY lo_model_name;
```

## Generating Groups

### 1. Single-Column Grouping

```sql
SELECT lo_model_name AS Model,
       COUNT(lo_id) AS 'Total Responses',
       SUM(lo_is_reviewed) AS 'Total Reviewed Responses',
       SUM(lo_is_reviewed)/COUNT(lo_id)  * 100 AS 'Review ratio'
FROM llm_output_v2
GROUP BY lo_model_name;
```

### 2. Multicolumn Grouping

```sql
SELECT lo_model_name AS Model,
       lo_prompt_category AS 'Prompt Category',
       COUNT(lo_id) AS 'Total Responses',
       AVG(lo_rating) AS 'Average Rating'
FROM llm_output_v2
GROUP BY lo_model_name, lo_prompt_category;
```

### 3. Grouping via Expressions

```sql
SELECT EXTRACT(YEAR FROM lo_date_created) AS 'Year',
       COUNT(*) AS 'Total Responses'
FROM llm_output_v2
GROUP BY EXTRACT(YEAR FROM lo_date_created);
```

### 4. Generating Rollups

```sql
SELECT lo_model_name AS Model,
       lo_prompt_category AS 'Prompt Category',
       AVG(lo_rating) AS 'Average Rating',
       COUNT(lo_id) AS 'Total Responses'
FROM llm_output_v2
GROUP BY lo_model_name, lo_prompt_category WITH ROLLUP;
```

## Filtering Groups

In filtering, you can:

1. Filter out records before grouping.

> Remove outputs created on 2024. We can use **WHERE** without any error.

2. Filter out groups after grouping.

> We can't filter group queries' resultsets with the usual **WHERE** clause, this becuase groups are not generated yet when **WHERE** clause is exucted.
> Instead we use **HAVING** clause to filter out the unwanted groups.

## HAVING

> Written and executed after **GROUP BY** clause.
> Used to filter out row groups based on logical condition.
> It's just the same as **WHERE** but the targted is the row groups rather than raw data.

### HAVING Examples

> We will see in the lab
